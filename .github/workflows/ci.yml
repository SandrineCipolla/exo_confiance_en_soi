name: CI/CD Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  # ==========================================
  # JOB 1 : BACKEND - Node.js Express
  # ==========================================
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: m2-confiance-en-soi-docker/back

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: m2-confiance-en-soi-docker/back/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¨ Check code formatting (Prettier)
        run: npm run format:check

      - name: ğŸ” Check for lint errors (ESLint)
        run: npm run lint

      - name: âœ… Verify backend starts
        run: |
          echo "Backend verification completed"

  # ==========================================
  # JOB 2 : FRONTEND - React + Vite
  # ==========================================
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: m2-confiance-en-soi-docker/front/frontend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: m2-confiance-en-soi-docker/front/frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¨ Check code formatting (Prettier)
        run: npm run format:check

      - name: ğŸ” Check for lint errors (ESLint)
        run: npm run lint

      - name: ğŸ—ï¸ Build frontend
        run: npm run build

      - name: ğŸ“Š Check build output
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Build successful - dist folder created"
            ls -la dist
          else
            echo "âŒ Build failed - dist folder not found"
            exit 1
          fi

  # ==========================================
  # JOB 3 : DOCKER BUILD (aprÃ¨s backend et frontend)
  # ==========================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend, frontend]  # Attend que backend et frontend rÃ©ussissent

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build Backend Docker Image
        run: |
          cd m2-confiance-en-soi-docker/back
          docker build -t confiance-en-soi-back:ci .
          echo "âœ… Backend image built successfully"

      - name: ğŸ”¨ Build Frontend Docker Image
        run: |
          cd m2-confiance-en-soi-docker/front/frontend
          docker build -t confiance-en-soi-front:ci .
          echo "âœ… Frontend image built successfully"

      - name: ğŸ“‹ List Docker images
        run: docker images | grep confiance-en-soi

  # ==========================================
  # JOB 4 : SUMMARY
  # ==========================================
  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, docker]
    if: always()

    steps:
      - name: ğŸ“Š Display results
        run: |
          echo "=========================================="
          echo "   CI/CD PIPELINE COMPLETED"
          echo "=========================================="
          echo ""
          echo "ğŸ“¦ BACKEND CHECKS:"
          echo "  â””â”€ Status: ${{ needs.backend.result }}"
          echo "     â”œâ”€ Install dependencies"
          echo "     â”œâ”€ Lint check (ESLint)"
          echo "     â””â”€ Verify backend"
          echo ""
          echo "ğŸ¨ FRONTEND CHECKS:"
          echo "  â””â”€ Status: ${{ needs.frontend.result }}"
          echo "     â”œâ”€ Install dependencies"
          echo "     â”œâ”€ Format check (Prettier)"
          echo "     â”œâ”€ Lint check (ESLint)"
          echo "     â””â”€ Build React app"
          echo ""
          echo "ğŸ³ DOCKER BUILD:"
          echo "  â””â”€ Status: ${{ needs.docker.result }}"
          echo "     â”œâ”€ Build backend image"
          echo "     â””â”€ Build frontend image"
          echo ""
          echo "=========================================="
          if [[ "${{ needs.backend.result }}" == "success" && "${{ needs.frontend.result }}" == "success" && "${{ needs.docker.result }}" == "success" ]]; then
            echo "âœ… RESULT: All checks passed!"
            echo "=========================================="
            exit 0
          else
            echo "âŒ RESULT: Some checks failed"
            echo "=========================================="
            exit 1
          fi
