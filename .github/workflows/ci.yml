name: CI/CD Pipeline

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ master]

jobs:
  # ==========================================
  # JOB 1 : BACKEND - Build + tests (via Docker)
  #==========================================
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: m2-confiance-en-soi-docker/back

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build Backend Docker Image (for tests)
        run: |
          docker build -t confiance-en-soi-back:test -f Dockerfile .
          echo "âœ… Backend test image built successfully"

      - name: ğŸ³ Run Backend Tests inside Docker (with coverage)
        run: |
          docker run --name confiance-back-test \
          confiance-en-soi-back:test npm run coverage

          docker cp confiance-back-test:/usr/src/app/coverage .
          docker rm confiance-back-test

      - name: ğŸ“¦ Prepare coverage for upload
        run: |
          mkdir -p $GITHUB_WORKSPACE/coverage-report
          # Copy HTML files from coverage/tmp if they exist there, otherwise from coverage root
          if [ -d "coverage/tmp" ] && [ -f "coverage/tmp/index.html" ]; then
            cp -r coverage/tmp/* $GITHUB_WORKSPACE/coverage-report/
          else
            cp -r coverage/* $GITHUB_WORKSPACE/coverage-report/
          fi

      - name: ğŸ“ˆ Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage-report
          if-no-files-found: error

      - name: ğŸ¨ Check code formatting (Prettier)
        run: docker run --rm confiance-en-soi-back:test npm run format:check

      - name: ğŸ” Check for lint errors (ESLint)
        run: docker run --rm confiance-en-soi-back:test npm run lint



  # ==========================================
  # JOB 2 : FRONTEND - React + Build
  # ==========================================
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: m2-confiance-en-soi-docker/front/frontend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: m2-confiance-en-soi-docker/front/frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¨ Check code formatting (Prettier)
        run: npm run format:check

      - name: ğŸ” Check for lint errors (ESLint)
        run: npm run lint

      - name: ğŸ—ï¸ Build frontend
        run: npm run build

      - name: ğŸ“Š Check build output
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Build successful - dist folder created"
            ls -la dist
          else
            echo "âŒ Build failed - dist folder not found"
            exit 1
          fi

      - name: ğŸ³ Build Frontend Docker Image (for future deploy)
        run: |
          docker build -t confiance-en-soi-front:ci -f Dockerfile .
          echo "âœ… Frontend Docker image built successfully"

  # ==========================================
  # JOB 3 : DEPLOY COVERAGE REPORT (GitHub Pages)
  # ==========================================
  deploy-coverage:
    name: Deploy Coverage Report (GitHub Pages)
    runs-on: ubuntu-latest
    needs: [backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    permissions:
      contents: read
      pages: write
      id-token: write

    concurrency:
      group: 'coverage-pages'
      cancel-in-progress: true

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: coverage

      - name: âš™ï¸ Setup Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Upload coverage to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage

      - name: ğŸš€ Deploy coverage report to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ==========================================
  # JOB 4: SUMMARY
  # ==========================================
  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: always()

    steps:
      - name: ğŸ“Š Display results
        run: |
          echo "CI/CD Pipeline Summary"
          echo "======================"
          echo "Backend:  ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "======================"

          if [[ "${{ needs.backend.result }}" == "success" && "${{ needs.frontend.result }}" == "success" ]]; then
            echo "âœ… All checks passed!"
            exit 0
          else
            echo "âŒ Some checks failed"
            exit 1
          fi