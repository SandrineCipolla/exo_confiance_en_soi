name: CI/CD Pipeline

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ master]

jobs:
  # ==========================================
  # JOB 1 : BACKEND - Build + tests (via Docker)
  #==========================================
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: m2-confiance-en-soi-docker/back

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build Backend Docker Image (for tests)
        run: |
          docker build -t confiance-en-soi-back:test -f Dockerfile .
          echo "âœ… Backend test image built successfully"

      - name: ğŸ³ Run Backend Tests inside Docker (with coverage)
        run: |
          mkdir -p coverage
          docker run --name confiance-back-test \
          confiance-en-soi-back:test npm run coverage || true

          echo "ğŸ“¦ Copying coverage results from container..."
          docker cp confiance-back-test:/usr/src/app/coverage ./
          docker rm confiance-back-test || true

      - name: ğŸ•µï¸ List coverage contents (debug)
        run: |
          echo "ğŸ“‚ Listing coverage directory contents:"
          ls -la coverage || true
          echo ""
          echo "ğŸ“‚ Listing coverage/output (if exists):"
          ls -la coverage/output || true

      - name: ğŸ“ˆ Upload coverage report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage/output
          if-no-files-found: error

      - name: ğŸ¨ Check code formatting (Prettier)
        run: docker run --rm confiance-en-soi-back:test npm run format:check

      - name: ğŸ” Check for lint errors (ESLint)
        run: docker run --rm confiance-en-soi-back:test npm run lint



  # ==========================================
  # JOB 2 : FRONTEND - React + Build
  # ==========================================
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: m2-confiance-en-soi-docker/front/frontend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: m2-confiance-en-soi-docker/front/frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¨ Check code formatting (Prettier)
        run: npm run format:check

      - name: ğŸ” Check for lint errors (ESLint)
        run: npm run lint

      - name: ğŸ—ï¸ Build frontend
        run: npm run build

      - name: ğŸ“Š Check build output
        run: |
          if [ -d "dist" ]; then
            echo "âœ… Build successful - dist folder created"
            ls -la dist
          else
            echo "âŒ Build failed - dist folder not found"
            exit 1
          fi

      - name: ğŸ³ Build Frontend Docker Image (for future deploy)
        run: |
          docker build -t confiance-en-soi-front:ci -f Dockerfile .
          echo "âœ… Frontend Docker image built successfully"

  # ==========================================
  # JOB 3 : DEPLOY COVERAGE REPORT (GitHub Pages)
  # ==========================================
  deploy-coverage:
    name: Deploy Coverage Report (GitHub Pages)
    runs-on: ubuntu-latest
    needs: [backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    permissions:
      contents: read
      pages: write
      id-token: write

    concurrency:
      group: 'coverage-pages'
      cancel-in-progress: true

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: coverage

      - name: âš™ï¸ Setup Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Upload coverage artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage

      - name: ğŸš€ Deploy coverage report to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ==========================================
  # JOB 4: SUMMARY
  # ==========================================
  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: always()

    steps:
      - name: ğŸ“Š Display results
        run: |
          echo "=========================================="
          echo "   CI/CD PIPELINE COMPLETED"
          echo "=========================================="
          echo ""
          echo "ğŸ“¦ BACKEND CHECKS:"
          echo "  â””â”€ Status: ${{ needs.backend.result }}"
          echo "     â”œâ”€ Docker build"
          echo "     â”œâ”€ Tests (Vitest)"
          echo "     â”œâ”€ Lint (ESLint)"
          echo "     â””â”€ Format (Prettier)"
          echo ""
          echo "ğŸ¨ FRONTEND CHECKS:"
          echo "  â””â”€ Status: ${{ needs.frontend.result }}"
          echo "     â”œâ”€ Build (Vite)"
          echo "     â”œâ”€ Lint + Prettier"
          echo "     â””â”€ Docker build"
          echo ""
          echo "=========================================="
          if [[ "${{ needs.backend.result }}" == "success" && "${{ needs.frontend.result }}" == "success" ]]; then
            echo "âœ… RESULT: All checks passed!"
            echo "=========================================="
            exit 0
          else
            echo "âŒ RESULT: Some checks failed"
            echo "=========================================="
            exit 1
          fi